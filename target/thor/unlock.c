#include <x509.h>
#include <debug.h>
#include <string.h>

static const char unlock_cert[] =
	"\x30\x82\x04\x45\x30\x82\x03\x2d\xa0\x03\x02\x01\x02\x02\x01\x01"
	"\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01\x05\x05\x00\x30"
	"\x7a\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02\x55\x53\x31\x13"
	"\x30\x11\x06\x03\x55\x04\x08\x13\x0a\x43\x61\x6c\x69\x66\x6f\x72"
	"\x6e\x69\x61\x31\x12\x30\x10\x06\x03\x55\x04\x07\x13\x09\x53\x75"
	"\x6e\x6e\x79\x76\x61\x6c\x65\x31\x13\x30\x11\x06\x03\x55\x04\x0b"
	"\x13\x0a\x55\x6e\x6c\x6f\x63\x6b\x20\x4b\x65\x79\x31\x0f\x30\x0d"
	"\x06\x03\x55\x04\x0a\x13\x06\x4c\x61\x62\x31\x32\x36\x31\x1c\x30"
	"\x1a\x06\x03\x55\x04\x03\x13\x13\x4c\x61\x62\x31\x32\x36\x20\x42"
	"\x6f\x6f\x74\x63\x68\x61\x69\x6e\x20\x43\x41\x30\x1e\x17\x0d\x31"
	"\x33\x30\x38\x32\x37\x31\x37\x33\x32\x35\x35\x5a\x17\x0d\x33\x33"
	"\x30\x38\x32\x32\x31\x37\x33\x32\x35\x35\x5a\x30\x7a\x31\x0b\x30"
	"\x09\x06\x03\x55\x04\x06\x13\x02\x55\x53\x31\x13\x30\x11\x06\x03"
	"\x55\x04\x08\x13\x0a\x43\x61\x6c\x69\x66\x6f\x72\x6e\x69\x61\x31"
	"\x12\x30\x10\x06\x03\x55\x04\x07\x13\x09\x53\x75\x6e\x6e\x79\x76"
	"\x61\x6c\x65\x31\x13\x30\x11\x06\x03\x55\x04\x0b\x13\x0a\x55\x6e"
	"\x6c\x6f\x63\x6b\x20\x4b\x65\x79\x31\x0f\x30\x0d\x06\x03\x55\x04"
	"\x0a\x13\x06\x4c\x61\x62\x31\x32\x36\x31\x1c\x30\x1a\x06\x03\x55"
	"\x04\x03\x13\x13\x4c\x61\x62\x31\x32\x36\x20\x42\x6f\x6f\x74\x63"
	"\x68\x61\x69\x6e\x20\x43\x41\x30\x82\x01\x20\x30\x0d\x06\x09\x2a"
	"\x86\x48\x86\xf7\x0d\x01\x01\x01\x05\x00\x03\x82\x01\x0d\x00\x30"
	"\x82\x01\x08\x02\x82\x01\x01\x00\xbe\x74\x49\x91\xdb\x09\x8b\xb0"
	"\xb2\xcc\x3b\x2f\xf4\xaf\x8d\xaf\x93\x5b\xdf\xa4\xcc\x4e\x1a\x2d"
	"\xe1\x3a\xdd\xba\xbd\xcb\x77\xed\xac\x53\x95\x6e\xc5\x75\x1c\x1f"
	"\xb7\x94\xe3\x18\xb9\x09\x69\x7b\xa0\x36\x81\x75\xa7\xe4\xfa\x6d"
	"\x08\xd1\x58\x56\x6e\x30\x7c\xce\x18\xa4\xa9\x99\x8e\x7b\xac\xa6"
	"\xae\xf5\xd3\x3f\x65\x6f\xcd\x72\xed\xb0\x5d\x47\xba\x3e\x84\x49"
	"\x14\xa8\xf1\xcf\xb2\xb0\x81\x34\xc4\x7a\x5e\x4a\x9e\xdb\x0d\x74"
	"\xe3\x67\x52\x6f\x81\xa9\x84\x4e\xe7\xa9\xe7\x26\x7b\xba\x83\x98"
	"\x47\xcb\x2c\xdd\xa6\x43\x3b\x4f\xa6\xfa\x1e\x29\x72\xb9\x79\xcb"
	"\xee\x55\x6b\x00\x12\x10\xb7\x89\x46\x5a\xfd\x18\x09\x0f\xa1\xd8"
	"\xdc\xf8\xa0\x9d\x74\xaf\x42\x9f\xc7\x50\xaa\x76\x03\xf7\x33\x38"
	"\xb7\xfd\x9b\xad\xc6\x0f\xb3\x44\x99\x73\x1e\xd7\x3f\xfa\x54\x40"
	"\x23\x14\xe2\x13\x80\xe5\x78\x8c\xd4\x43\xda\xf2\xed\x20\x69\xe7"
	"\x3b\x8a\x31\xce\x8b\x5f\x93\x05\xb9\x0e\x1d\x39\xe5\xb3\x8b\x30"
	"\x4d\x76\x74\x56\xb0\xc2\xbd\x0f\xd4\xfa\x2c\x9d\xc1\x1e\xf2\x49"
	"\xc8\x23\x5b\x83\x75\x9e\xf5\x27\x80\x4c\x6c\x96\x95\x3c\xf2\xaa"
	"\xf6\xbf\x24\xbb\xa6\xff\x25\x5b\x02\x01\x03\xa3\x81\xd7\x30\x81"
	"\xd4\x30\x1d\x06\x03\x55\x1d\x0e\x04\x16\x04\x14\x6a\x9a\x41\xd4"
	"\x56\xe3\xc5\xff\xa5\x38\x76\x13\xc9\x91\xc2\x2f\xc9\xdc\x1c\xbc"
	"\x30\x81\xa4\x06\x03\x55\x1d\x23\x04\x81\x9c\x30\x81\x99\x80\x14"
	"\x6a\x9a\x41\xd4\x56\xe3\xc5\xff\xa5\x38\x76\x13\xc9\x91\xc2\x2f"
	"\xc9\xdc\x1c\xbc\xa1\x7e\xa4\x7c\x30\x7a\x31\x0b\x30\x09\x06\x03"
	"\x55\x04\x06\x13\x02\x55\x53\x31\x13\x30\x11\x06\x03\x55\x04\x08"
	"\x13\x0a\x43\x61\x6c\x69\x66\x6f\x72\x6e\x69\x61\x31\x12\x30\x10"
	"\x06\x03\x55\x04\x07\x13\x09\x53\x75\x6e\x6e\x79\x76\x61\x6c\x65"
	"\x31\x13\x30\x11\x06\x03\x55\x04\x0b\x13\x0a\x55\x6e\x6c\x6f\x63"
	"\x6b\x20\x4b\x65\x79\x31\x0f\x30\x0d\x06\x03\x55\x04\x0a\x13\x06"
	"\x4c\x61\x62\x31\x32\x36\x31\x1c\x30\x1a\x06\x03\x55\x04\x03\x13"
	"\x13\x4c\x61\x62\x31\x32\x36\x20\x42\x6f\x6f\x74\x63\x68\x61\x69"
	"\x6e\x20\x43\x41\x82\x01\x01\x30\x0c\x06\x03\x55\x1d\x13\x04\x05"
	"\x30\x03\x01\x01\xff\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01"
	"\x01\x05\x05\x00\x03\x82\x01\x01\x00\x7b\xbd\x1a\x84\x77\x00\x96"
	"\x6e\xc0\x0e\x18\xb2\x87\xb8\x91\xe5\xcb\x72\xc6\x20\x87\x21\xce"
	"\x24\x5d\x40\xf1\x2a\x26\xe4\x9b\x64\xd8\xcc\xfc\x37\xe1\xb8\x88"
	"\x86\x9e\xa9\xf5\x42\x39\x5d\x24\x26\x9b\xeb\x04\xf2\x57\xc0\x50"
	"\x60\x40\x81\x28\xa2\xf1\x50\x49\x6d\xcd\x22\xb3\x5b\x1e\xfc\x3e"
	"\xc0\xb4\x20\xbb\x2a\x0e\x6e\x1e\x81\x86\xd6\xae\x42\x7b\x41\x8a"
	"\x28\xb5\x14\xde\x19\x12\xad\xc2\xba\x5d\x33\x8c\xce\x7e\x68\x3c"
	"\xe9\x71\x9e\x1f\xf9\x7c\x0c\x19\x5b\xbd\xea\xd8\x10\x31\xc9\x3f"
	"\xeb\xc5\xbd\x89\xaf\x1f\x8d\x84\xa7\x9f\xd8\x65\x45\xc2\x91\x85"
	"\x0f\xc4\x5e\xe0\x56\x06\xb2\x23\x39\xcb\x3b\x8b\x00\x15\xe7\xb8"
	"\x79\x09\x46\xa7\x7d\x90\x39\x15\xc9\x44\xd0\xc8\xc3\x99\x7e\x14"
	"\x81\x14\xfb\x96\xe7\x29\x84\x7d\x69\x1a\x54\x08\xef\x7a\xaf\x90"
	"\x51\xfe\x84\x81\x0e\xd9\xa6\x2c\x89\xf8\x4d\x06\x1a\x12\x47\x49"
	"\x3e\xb1\xe1\x01\x3a\x08\x19\x60\xbd\xa3\x8f\xef\x7c\x27\xd5\xa1"
	"\xa5\x7e\x73\xff\x78\x2f\x92\x9f\x3b\xdc\x43\x71\x57\x97\x43\xe4"
	"\xe0\xea\xa1\xf7\x90\x20\xd2\xec\xd7\xcc\x51\x4b\x55\xd9\xec\x6b"
	"\xc7\xfe\x84\x87\xad\xd1\x24\xf5\x5e"
	;

static const int unlock_cert_size = 1097;

int target_unlock(void *data, int sz)
{
	X509 *x509_certificate = NULL;
	EVP_PKEY *pub_key = NULL;
	RSA *rsa_key = NULL;
	char plain_text[256], signature[16];
	unsigned char *data_ptr = unlock_cert;
	int rc = 1, ret = 0;

	memset(plain_text, 0, sizeof(plain_text));

	/* Extract public key from the hard coded certificate */
	if ((x509_certificate = d2i_X509(NULL, &data_ptr, unlock_cert_size)) == NULL) {
		dprintf(CRITICAL,
			"ERROR: Image Invalid, X509_Certificate is NULL %d!\n", ERR_get_error());
		goto done;
	}
	pub_key = X509_get_pubkey(x509_certificate);
	rsa_key = EVP_PKEY_get1_RSA(pub_key);

	if (rsa_key == NULL) {
		dprintf(CRITICAL, "ERROR: Boot Invalid, RSA_KEY is NULL!\n");
		goto done;
	}

	/* Decrypt data with public key */
	ret = RSA_public_decrypt(sizeof(plain_text), data, plain_text,
				 rsa_key, RSA_PKCS1_PADDING);

	if (ret == -1)
		goto done;

	/* Compare EMMC ID with decrypted signature */
	snprintf(signature, sizeof(signature), "0x%02x%08x", mmc_get_manfid(), mmc_get_psn());

	if (memcmp(signature, plain_text, strlen(signature)) == 0)
	{
		dprintf(INFO, "Unlock code is correct\n");
		rc = 0;
	}
	else
	{
		dprintf(INFO, "Unlock code is NOT correct\n");
	}

	if (rsa_key != NULL)
		RSA_free(rsa_key);
	if (x509_certificate != NULL)
		X509_free(x509_certificate);
	if (pub_key != NULL)
		EVP_PKEY_free(pub_key);


done:
	return rc;
}

int target_verify_unlock_code(void)
{
	char unlock_code[512];
	char *b64 = NULL;
	int skip_authentication = 0;

	/* Extract unlock code from IDME */
	idme_get_var_external("unlock_code", unlock_code, sizeof(unlock_code));

	if (strlen(unlock_code))
	{
		if (b64 = base64_decode(unlock_code))
		{
			/* Check if unlock code is correct */
			if (target_unlock(b64, 256) == 0)
				skip_authentication = 1;
			free(b64);
		}
	}

	if (skip_authentication)
	{
		return 1;
	} else {
		return 0;
	}
}
